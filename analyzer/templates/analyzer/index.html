<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4b0.svg" type="image/svg+xml">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Strategist Pro - Genera Estrategias con IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .main-card { 
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .tab-content { background: transparent; }
        .nav-pills .nav-link { 
            border-radius: 15px;
            margin: 0 5px;
            font-weight: 600;
        }
        .nav-pills .nav-link.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .form-control { 
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus { 
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            z-index: 9999;
        }
        .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        .error-alert { 
            border-radius: 12px;
            border: none;
        }
        .success-result {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- ‚úÖ LOADING OVERLAY -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <h4 class="mt-3" id="loadingText">Analizando producto...</h4>
            <p id="loadingSubtext">Finalizando an√°lisis...</p>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- ‚úÖ HEADER MEJORADO -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="text-white display-6 mb-0">
                            <i class="fas fa-rocket me-3"></i>Affiliate Strategist Pro
                        </h1>
                        <p class="text-white-50 mb-0">Genera estrategias de marketing con IA avanzada</p>
                    </div>
                    <div>
                        {% if user.is_authenticated %}
                            <div class="dropdown">
                                <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-2"></i>{{ user.username }}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/profile/"><i class="fas fa-user me-2"></i>Mi Perfil</a></li>
                                    <li><a class="dropdown-item" href="/history/"><i class="fas fa-history me-2"></i>Historial</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/logout/"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n</a></li>
                                </ul>
                            </div>
                        {% else %}
                            <a href="/login/" class="btn btn-outline-light me-2">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesi√≥n
                            </a>
                            <a href="/register/" class="btn btn-light">
                                <i class="fas fa-user-plus me-2"></i>Registrarse
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- AGREGAR despu√©s del header, antes del main-card -->

        {% if user.is_authenticated %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert {% if user.profile.analyses_remaining <= 1 %}alert-warning{% else %}alert-info{% endif %} d-flex justify-content-between align-items-center">
                    <div>
                        <strong>
                            {{ user.profile.get_plan_display_with_emoji }} 
                            - An√°lisis este mes: {{ user.profile.analyses_this_month }}/{{ user.profile.analyses_limit_monthly }}
                        </strong>
                        {% if user.profile.analyses_remaining == 0 %}
                            <span class="text-danger ms-3">¬°Has alcanzado tu l√≠mite mensual!</span>
                        {% elif user.profile.analyses_remaining <= 2 %}
                            <span class="text-warning ms-3">Te quedan {{ user.profile.analyses_remaining }} an√°lisis</span>
                        {% endif %}
                    </div>
                    {% if user.profile.plan == 'free' %}
                    <a href="/upgrade/" class="btn btn-sm btn-warning">
                        <i class="fas fa-crown me-1"></i>Obtener Pro
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Como visitante tienes 2 an√°lisis gratuitos por d√≠a. 
                    <a href="/register/" class="alert-link">Reg√≠strate gratis</a> para obtener 5 an√°lisis mensuales.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ‚úÖ MAIN CONTENT -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="main-card p-4">
                    <!-- ‚úÖ ALERT SYSTEM -->
                    <div id="alertContainer"></div>

                    <!-- ‚úÖ TABS NAVIGATION -->
                    <ul class="nav nav-pills justify-content-center mb-4" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="pill" data-bs-target="#basic" type="button">
                                <i class="fas fa-chart-line me-2"></i>An√°lisis B√°sico
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="competitive-tab" data-bs-toggle="pill" data-bs-target="#competitive" type="button">
                                <i class="fas fa-sword me-2"></i>An√°lisis Competitivo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="batch-tab" data-bs-toggle="pill" data-bs-target="#batch" type="button">
                                <i class="fas fa-list me-2"></i>An√°lisis en Lote
                            </button>
                        </li>
                    </ul>

                    <!-- ‚úÖ TAB CONTENT -->
                    <div class="tab-content">
                        <!-- AN√ÅLISIS B√ÅSICO -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <form id="basicAnalysisForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="analysis_type" value="basic">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-link me-2 text-primary"></i>URL del Producto *
                                        </label>
                                        <input type="url" name="product_url" class="form-control" required
                                               placeholder="https://ejemplo.com/producto">
                                        <small class="text-muted">Amazon, MercadoLibre, Shopify, etc.</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-share-alt me-2 text-primary"></i>Plataforma Principal
                                        </label>
                                        <select name="platform" class="form-select">
                                            <option value="tiktok">TikTok</option>
                                            <option value="instagram">Instagram</option>
                                            <option value="youtube">YouTube</option>
                                            <option value="facebook">Facebook</option>
                                            <option value="twitter">Twitter</option>
                                            <option value="linkedin">LinkedIn</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-users me-2 text-primary"></i>P√∫blico Objetivo
                                        </label>
                                        <input type="text" name="target_audience" class="form-control" required
                                               placeholder="ej: mujeres 25-40 a√±os interesadas en fitness">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-bullseye me-2 text-primary"></i>Objetivo de Campa√±a
                                        </label>
                                        <select name="campaign_goal" class="form-select">
                                            <option value="conversions">Conversiones</option>
                                            <option value="awareness">Conocimiento de marca</option>
                                            <option value="engagement">Engagement</option>
                                            <option value="traffic">Tr√°fico web</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-dollar-sign me-2 text-primary"></i>Presupuesto
                                        </label>
                                        <select name="budget" class="form-select">
                                            <option value="low">Bajo (< $500)</option>
                                            <option value="medium" selected>Medio ($500-2000)</option>
                                            <option value="high">Alto (> $2000)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-microphone me-2 text-primary"></i>Tono de Comunicaci√≥n
                                        </label>
                                        <select name="tone" class="form-select">
                                            <option value="professional" selected>Profesional</option>
                                            <option value="casual">Casual</option>
                                            <option value="funny">Divertido</option>
                                            <option value="educational">Educativo</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-comment me-2 text-primary"></i>Contexto Adicional (Opcional)
                                    </label>
                                    <textarea name="additional_context" class="form-control" rows="3"
                                              placeholder="Informaci√≥n adicional sobre tu negocio, experiencia previa, objetivos espec√≠ficos..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-key me-2 text-primary"></i>API Key de Gemini *
                                    </label>
                                    <input type="password" name="api_key" class="form-control" required
                                           placeholder="Tu clave API de Google Gemini">
                                    <small class="text-muted">
                                        <a href="https://makersuite.google.com/app/apikey" target="_blank">
                                            Obtener API Key gratuita
                                        </a>
                                    </small>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submitBasicBtn">
                                        <i class="fas fa-rocket me-2"></i>Generar Estrategia
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- AN√ÅLISIS COMPETITIVO -->
                        <div class="tab-pane fade" id="competitive" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>An√°lisis Competitivo:</strong> Compara tu producto con hasta 5 competidores
                            </div>
                            
                            <form id="competitiveAnalysisForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="analysis_type" value="competitive">
                                
                                <!-- Producto principal -->
                                <div class="mb-4">
                                    <h5 class="text-primary">
                                        <i class="fas fa-star me-2"></i>Tu Producto Principal
                                    </h5>
                                    <input type="url" name="main_product_url" class="form-control" required
                                           placeholder="URL de tu producto principal">
                                </div>

                                <!-- Competidores -->
                                <div class="mb-4">
                                    <h5 class="text-warning">
                                        <i class="fas fa-sword me-2"></i>Competidores (Opcional)
                                    </h5>
                                    <div class="row">
                                        {% for i in "12345" %}
                                        <div class="col-md-6 mb-2">
                                            <input type="url" name="competitor_{{ i }}" class="form-control"
                                                   placeholder="URL del competidor {{ i }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Plataforma Principal</label>
                                        <select name="platform" class="form-select">
                                            <option value="tiktok">TikTok</option>
                                            <option value="instagram">Instagram</option>
                                            <option value="youtube">YouTube</option>
                                            <option value="facebook">Facebook</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">P√∫blico Objetivo</label>
                                        <input type="text" name="target_audience" class="form-control" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">API Key de Gemini *</label>
                                    <input type="password" name="api_key" class="form-control" required>
                                </div>

                                <div class="text-center">
                                    <button type="submit" class="btn btn-warning btn-lg" id="submitCompetitiveBtn">
                                        <i class="fas fa-chart-bar me-2"></i>An√°lisis Competitivo
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- AN√ÅLISIS EN LOTE -->
                        <div class="tab-pane fade" id="batch" role="tabpanel">
                            <div class="alert alert-warning">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Pr√≥ximamente:</strong> An√°lisis de m√∫ltiples productos simultaneamente
                            </div>
                            <div class="text-center py-5">
                                <i class="fas fa-cogs fa-4x text-muted mb-3"></i>
                                <h4>Funci√≥n en Desarrollo</h4>
                                <p class="text-muted">Esta funcionalidad estar√° disponible en la pr√≥xima versi√≥n.</p>
                            </div>
                        </div>
                    </div>

                    <!-- ‚úÖ RESULTS SECTION -->
                    <div id="resultsSection" style="display: none;">
                        <hr class="my-4">
                        <h4 class="text-primary">
                            <i class="fas fa-chart-line me-2"></i>Resultados del An√°lisis
                        </h4>
                        <div id="resultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ FOOTER -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <div class="text-white-50">
                    <a href="/history/" class="text-white-50 text-decoration-none me-3">
                        <i class="fas fa-history me-1"></i>Historial
                    </a>
                    <a href="/public-history/" class="text-white-50 text-decoration-none me-3">
                        <i class="fas fa-globe me-1"></i>P√∫blico
                    </a>
                    <a href="/upgrade/" class="text-white-50 text-decoration-none">
                        <i class="fas fa-star me-1"></i>Premium
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ JAVASCRIPT MEJORADO -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ SISTEMA DE ALMACENAMIENTO DE RESULTADOS MEJORADO
    let analysisResults = {
        basic: null,
        competitive: null
    };
    
    let currentDownloadId = null; // Para PDFs
    
    // ‚úÖ FORMULARIOS
    const basicForm = document.getElementById('basicAnalysisForm');
    const competitiveForm = document.getElementById('competitiveAnalysisForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const alertContainer = document.getElementById('alertContainer');
    const resultsSection = document.getElementById('resultsSection');

    // ‚úÖ FUNCI√ìN PARA MOSTRAR ALERTAS
    function showAlert(message, type = 'danger') {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // ‚úÖ FUNCI√ìN PARA MOSTRAR/OCULTAR LOADING
    function showLoading(show = true) {
        loadingOverlay.style.display = show ? 'block' : 'none';
        
        if (show) {
            const texts = ['Analizando producto...', 'Procesando datos...', 'Generando estrategia...', 'Finalizando...'];
            let currentText = 0;
            const interval = setInterval(() => {
                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.textContent = texts[currentText];
                    currentText = (currentText + 1) % texts.length;
                }
            }, 2000);
            loadingOverlay.dataset.interval = interval;
        } else {
            if (loadingOverlay.dataset.interval) {
                clearInterval(loadingOverlay.dataset.interval);
            }
        }
    }

    // ‚úÖ FUNCI√ìN PARA MANEJAR ENV√çO DE FORMULARIOS
    function handleFormSubmit(form, analysisType) {
        return new Promise((resolve, reject) => {
            const formData = new FormData(form);
            formData.set('analysis_type', analysisType);

            fetch('/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ‚úÖ GUARDAR RESULTADO
                    analysisResults[analysisType] = {
                        response: data.response,
                        analysisId: data.analysis_id,
                        productInfo: data.product || data.product_info,
                        timestamp: new Date().toLocaleString()
                    };
                    // ‚úÖ Actualizar banner de uso si viene en la respuesta
                    if (data.usage) {
                        const banner = document.querySelector('.alert.alert-info, .alert.alert-warning');
                        if (banner) {
                            const planLabel = data.usage.plan === 'premium' ? 'üíé Premium' : 'üÜì Gratuito';
                            banner.classList.remove('alert-info','alert-warning');
                            banner.classList.add(data.usage.remaining <= 1 ? 'alert-warning' : 'alert-info');
                            banner.innerHTML = `
                                <div>
                                    <strong>${planLabel} - An√°lisis este mes: ${data.usage.this_month}/${data.usage.limit}</strong>
                                    ${data.usage.remaining === 0 ? '<span class="text-danger ms-3">¬°Has alcanzado tu l√≠mite mensual!</span>' : (data.usage.remaining <= 2 ? `<span class="text-warning ms-3">Te quedan ${data.usage.remaining} an√°lisis</span>` : '')}
                                </div>
                                ${data.usage.plan === 'free' ? '<a href="/upgrade/" class="btn btn-sm btn-warning"><i class="fas fa-crown me-1"></i>Obtener Pro</a>' : ''}
                            `;
                        }
                    }
                    
                    currentDownloadId = data.analysis_id;
                    resolve(data);
                } else {
                    reject(data.error || 'Error desconocido');
                }
            })
            .catch(error => {
                reject('Error de conexi√≥n: ' + error.message);
            });
        });
    }

    // ‚úÖ FUNCI√ìN PARA MOSTRAR RESULTADOS
    function showResults() {
        const hasBasic = analysisResults.basic !== null;
        const hasCompetitive = analysisResults.competitive !== null;
        const hasBoth = hasBasic && hasCompetitive;

        // Mostrar secci√≥n de resultados
        resultsSection.style.display = 'block';
        
        // ‚úÖ CREAR TABS SI HAY M√öLTIPLES RESULTADOS
        let tabsHtml = '';
        let contentHtml = '';

        if (hasBoth) {
            tabsHtml = `
                <ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-results-tab" data-bs-toggle="tab" 
                                data-bs-target="#basic-results" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>An√°lisis B√°sico
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="competitive-results-tab" data-bs-toggle="tab" 
                                data-bs-target="#competitive-results" type="button" role="tab">
                            <i class="fas fa-sword me-2"></i>An√°lisis Competitivo
                        </button>
                    </li>
                </ul>
            `;
        }

        // ‚úÖ CONTENIDO DE TABS
        contentHtml = '<div class="tab-content" id="resultsTabContent">';

        if (hasBasic) {
            contentHtml += `
                <div class="tab-pane fade ${!hasCompetitive || hasBoth ? 'show active' : ''}" 
                     id="basic-results" role="tabpanel">
                    ${createResultCard('basic', analysisResults.basic)}
                </div>
            `;
        }

        if (hasCompetitive) {
            contentHtml += `
                <div class="tab-pane fade ${!hasBasic ? 'show active' : ''}" 
                     id="competitive-results" role="tabpanel">
                    ${createResultCard('competitive', analysisResults.competitive)}
                </div>
            `;
        }

        contentHtml += '</div>';

        // ‚úÖ INSERTAR HTML
        document.getElementById('resultsContent').innerHTML = tabsHtml + contentHtml;
        
        // Scroll a resultados
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // ‚úÖ FUNCI√ìN PARA CREAR CARDS DE RESULTADOS
    function createResultCard(type, result) {
        const typeDisplay = type === 'basic' ? 'B√°sico' : 'Competitivo';
        const iconClass = type === 'basic' ? 'chart-line' : 'sword';
        const colorClass = type === 'basic' ? 'primary' : 'warning';

        return `
            <div class="card border-${colorClass}">
                <div class="card-header bg-${colorClass} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-${iconClass} me-2"></i>
                        Estrategia ${typeDisplay}
                    </h5>
                    <small>Generado: ${result.timestamp}</small>
                </div>
                <div class="card-body">
                    ${result.productInfo ? `
                        <div class="alert alert-info">
                            <strong>üì¶ Producto:</strong> ${result.productInfo.title || 'N/A'}<br>
                            <strong>üí∞ Precio:</strong> ${result.productInfo.price || 'N/A'}
                        </div>
                    ` : ''}
                    
                    <div class="strategy-content">
                        <pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 15px; border-radius: 8px;">${result.response}</pre>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <a class="btn btn-success" href="/download-pdf/${result.analysisId}/" target="_blank" rel="noopener">
                            <i class="fas fa-download me-2"></i>Descargar PDF
                        </a>
                        <button class="btn btn-outline-primary" onclick="shareStrategy()">
                            <i class="fas fa-share me-2"></i>Compartir
                        </button>
                        <button class="btn btn-outline-secondary" onclick="copyStrategy('${type}')">
                            <i class="fas fa-copy me-2"></i>Copiar
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ‚úÖ EVENT LISTENERS PARA FORMULARIOS
    if (basicForm) {
        basicForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!basicForm.checkValidity()) {
                basicForm.classList.add('was-validated');
                return;
            }

            showLoading(true);
            alertContainer.innerHTML = '';

            try {
                const result = await handleFormSubmit(basicForm, 'basic');
                showAlert('¬°An√°lisis b√°sico completado!', 'success');
                showResults();
            } catch (error) {
                showAlert(error, 'danger');
            } finally {
                showLoading(false);
            }
        });
    }

    if (competitiveForm) {
        competitiveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!competitiveForm.checkValidity()) {
                competitiveForm.classList.add('was-validated');
                return;
            }

            showLoading(true);
            alertContainer.innerHTML = '';

            try {
                const result = await handleFormSubmit(competitiveForm, 'competitive');
                showAlert('¬°An√°lisis competitivo completado!', 'success');
                showResults();
            } catch (error) {
                showAlert(error, 'danger');
            } finally {
                showLoading(false);
            }
        });
    }

    // ‚úÖ FUNCIONES GLOBALES
    window.downloadPDF = function(analysisId) {
        if (!analysisId) {
            showAlert('ID de an√°lisis no disponible', 'warning');
            return;
        }
        
        const url = `/download-pdf/${analysisId}/`;
        window.open(url, '_blank');
    };

    window.shareStrategy = function() {
        if (navigator.share) {
            navigator.share({
                title: 'Estrategia de Marketing - Affiliate Strategist Pro',
                text: 'Mira esta estrategia generada con IA',
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            showAlert('¬°Link copiado al portapapeles!', 'success');
        }
    };

    window.copyStrategy = function(type) {
        const result = analysisResults[type];
        if (result) {
            navigator.clipboard.writeText(result.response);
            showAlert('¬°Estrategia copiada al portapapeles!', 'success');
        }
    };

    // ‚úÖ AUTO-SAVE DE FORMULARIOS
    function saveFormData(form) {
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'api_key' && key !== 'csrfmiddlewaretoken') {
                data[key] = value;
            }
        }
        localStorage.setItem(form.id + '_data', JSON.stringify(data));
    }

    function loadFormData(form) {
        const savedData = localStorage.getItem(form.id + '_data');
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key];
                }
            });
        }
    }

    // Cargar datos guardados
    if (basicForm) loadFormData(basicForm);
    if (competitiveForm) loadFormData(competitiveForm);

    // Guardar al cambiar
    document.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('change', function() {
            const form = this.closest('form');
            if (form) saveFormData(form);
        });
    });
});
    </script>
</body>
</html>